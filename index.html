<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chattanooga Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map { 
            height: 100vh;
            width: 100%;
        }
        .custom-marker-icon {
            border: 2px solid #ffffff;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            line-height: 30px;
        }
        .dropdown-container {
            position: absolute;
            top: 10px;
            right: 60px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        #property-selector {
            position: absolute;
            top: 50px;
            left: 50px;
            z-index: 1000;
            padding: 5px;
            background: rgb(250, 251, 251);
            border: 1px solid #ccc;
            max-width: 300px;
            font-size: 14px;
        }
        #property-search-container {
            position: absolute;
            top: 80px;
            left: 50px;
            z-index: 1000;
            max-width: 300px;
        }
        #property-search {
            width: 100%;
            padding: 5px;
            background: rgb(250, 251, 251);
            border: 1px solid #ccc;
            font-size: 14px;
        }
        #search-results {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            display: none;
        }
        #search-results div {
            padding: 5px;
            cursor: pointer;
        }
        #search-results div:hover {
            background: #f0f0f0;
        }
        #market-selector, .toggle-container {
            padding: 5px;
            background: rgb(250, 251, 251);
            border: 1px solid #ccc;
            max-width: 300px;
            font-size: 14px;
        }
        .map-title {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            font-size: 24px;
            font-weight: bold;
            color: #333;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
        }
        .logo {
            position: absolute;
            bottom: 10px;
            left: 20px;
            width: 70px;
            height: 50px;
            z-index: 1000;
            background-color: #fcfdfeee;
            padding: 3px 10px;
            border-radius: 3px;
            color: rgb(16, 17, 17);
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }
        .date-time {
            position: absolute;
            top: 10px;
            left: 300px;
            z-index: 1000;
            font-size: 16px;
            color: #333;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
        }
        .leaflet-control-layers-expanded {
            z-index: 1200 !important;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1300;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #exclusions-list {
            list-style-type: none;
            padding: 0;
        }
        #exclusions-list li {
            margin-bottom: 5px;
        }
        #loading-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 4px;
            display: none;
        }
        table.key-table {
            border-collapse: collapse;
            font-size: 12px;
            max-width: 100%;
        }
        table.key-table th, table.key-table td {
            border: 1px solid #ddd;
            padding: 4px;
            line-height: 1.2;
        }
        table.key-table th {
            background-color: #f2f2f2;
            text-align: left;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="map-title">Chattanooga Map</div>
    <div class="logo">NATIONAL --- IOS ---<br></div>
    <div id="loading-indicator">Loading properties...</div>
    <div class="date-time" id="date-time"></div>
    <select id="property-selector">
        <option value="">Loading properties...</option>
    </select>
    <div id="property-search-container">
        <input type="text" id="property-search" placeholder="Search properties...">
        <div id="search-results"></div>
    </div>
    <div class="dropdown-container">
        <select id="market-selector" class="toggle-container">
            <option value="">Loading markets...</option>
        </select>
        <button id="manage-exclusions">Manage Exclusions</button>
        <button id="send-excluded">Send Excluded List</button>
        <button id="screenshot-markets">Take Screenshot of Markets</button>
    </div>
    <div id="map"></div>
    <div id="exclusions-modal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Manage Exclusions (Check to Exclude)</h2>
            <ul id="exclusions-list"></ul>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Set dynamic date and time
        const now = new Date();
        const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'America/Chicago' };
        const dateOptions = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', timeZone: 'America/Chicago' };
        const timeString = now.toLocaleTimeString('en-US', timeOptions).replace(/^0/, '');
        const dateString = now.toLocaleDateString('en-US', dateOptions);
        document.getElementById('date-time').innerHTML = `${timeString} CDT, ${dateString}`;

        // Initialize map with a fallback view
        const map = L.map('map').setView([37.0902, -95.7129], 4); // Center of US as fallback

        // Define base layers
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles © Esri — Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        });

        const baseLayers = {
            "Street Map": streetLayer,
            "Satellite": satelliteLayer
        };

        // Define FEMA flood overlay with error handling
        let floodLayer;
        try {
            floodLayer = L.esri.dynamicMapLayer({
                url: 'https://hazards.fema.gov/gis/nfhl/services/public/NFHL/MapServer',
                layers: [28], // Layer 28: Flood Hazard Zones (S_FLD_HAZ_AR)
                opacity: 0.5,
                attribution: 'FEMA National Flood Hazard Layer'
            });
            floodLayer.on('load', () => console.log('FEMA Flood Layer loaded successfully'));
            floodLayer.on('error', (err) => console.error('FEMA Flood Layer error:', err));
        } catch (error) {
            console.error('Error initializing FEMA Flood Layer:', error);
            floodLayer = L.layerGroup(); // Fallback empty layer
        }

        const overlays = {
            "FEMA Flood Zones": floodLayer
        };

        L.control.layers(baseLayers, overlays, { collapsed: true }).addTo(map);

        // Global variables
        const markers = {};
        let properties = [];
        const excluded = new Set();
        const defaultColor = '#3374ff';
        const marketColors = {
            'Dallas': '#FF5733', // Red-orange
            'Houston': '#33FF57', // Green
            'Austin': '#3357FF', // Blue
            'default': '#3374ff' // Fallback
        };

        // City coordinates for markets
        const marketCityCoords = {
            'Dallas': [32.7767, -96.7970],
            'Houston': [29.7604, -95.3698],
            'Austin': [30.2672, -97.7431]
        };

        // Wait for map tiles to load
        async function waitForTilesLoaded(layer) {
            return new Promise((resolve) => {
                layer.on('load', resolve);
                layer.redraw();
                setTimeout(resolve, 10000);
            });
        }

        // Take screenshots for each market
        async function takeMarketScreenshots() {
            const markets = [...new Set(properties.map(p => p.market).filter(m => m !== 'N/A' && m !== ''))];
            const currentZoom = map.getZoom();
            const currentCenter = map.getCenter();
            const originalLayer = map.hasLayer(satelliteLayer) ? satelliteLayer : streetLayer;

            // Store original display styles
            const dropdownContainer = document.querySelector('.dropdown-container');
            const propertySelector = document.getElementById('property-selector');
            const propertySearchContainer = document.getElementById('property-search-container');
            const dateTime = document.getElementById('date-time');
            const originalStyles = {
                dropdownContainer: dropdownContainer.style.display,
                propertySelector: propertySelector.style.display,
                propertySearchContainer: propertySearchContainer.style.display,
                dateTime: dateTime.style.display
            };

            const screenshots = [];

            for (const market of markets) {
                const marketProperties = properties.filter(prop => prop.market === market && !excluded.has(properties.indexOf(prop)));
                if (marketProperties.length === 0) continue;

                const bounds = L.latLngBounds(marketProperties.map(prop => [prop.lat, prop.lng]));
                const cityCoords = marketCityCoords[market] || bounds.getCenter();
                const zoomLevel = 11;

                Object.keys(markers).forEach(index => {
                    const prop = properties[index];
                    if (prop.market === market && !excluded.has(parseInt(index))) {
                        if (!map.hasLayer(markers[index])) {
                            markers[index].addTo(map);
                        }
                    } else {
                        if (map.hasLayer(markers[index])) {
                            map.removeLayer(markers[index]);
                        }
                    }
                });

                map.setView(cityCoords, zoomLevel);
                map.fitBounds(bounds.pad(0.5)); // Increased padding to 0.5 for more zoomed out view
                await new Promise(resolve => setTimeout(resolve, 2000));

                map.removeLayer(satelliteLayer);
                streetLayer.addTo(map);
                await waitForTilesLoaded(streetLayer);

                await new Promise(resolve => setTimeout(resolve, 2000));

                // Hide UI elements
                dropdownContainer.style.display = 'none';
                propertySelector.style.display = 'none';
                propertySearchContainer.style.display = 'none';
                dateTime.style.display = 'none';

                // Create key div
                let keyDiv = document.createElement('div');
                keyDiv.style.position = 'absolute';
                keyDiv.style.bottom = '70px'; // Above logo
                keyDiv.style.right = '10px'; // Bottom-right corner
                keyDiv.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                keyDiv.style.padding = '8px';
                keyDiv.style.border = '1px solid #ccc';
                keyDiv.style.borderRadius = '4px';
                keyDiv.style.zIndex = '1000';
                keyDiv.style.maxWidth = '300px';
                keyDiv.style.overflow = 'auto';

                let keyHtml = `<h3 style="font-size: 16px; margin: 0 0 5px 0;">${market} Market Key</h3><table class="key-table"><tr><th>Number</th><th>Address</th><th>Acreage</th></tr>`;
                marketProperties.forEach(prop => {
                    const index = properties.indexOf(prop);
                    const num = index + 1;
                    const name = prop.name;
                    const ac = prop.ac || 'N/A';
                    keyHtml += `<tr><td>${num}</td><td>${name}</td><td>${ac}</td></tr>`;
                });
                keyHtml += '</table>';
                keyDiv.innerHTML = keyHtml;
                document.body.appendChild(keyDiv);

                // Wait for key div to render
                await new Promise(resolve => setTimeout(resolve, 1000));

                try {
                    const canvas = await html2canvas(document.body, {
                        useCORS: true,
                        allowTaint: false,
                        logging: false,
                        width: window.innerWidth,
                        height: window.innerHeight,
                        scale: window.devicePixelRatio
                    });
                    const dataURL = canvas.toDataURL('image/png');
                    screenshots.push({ market, dataURL });
                } catch (error) {
                    console.error(`Error taking screenshot for market ${market}:`, error);
                    alert(`Failed to take screenshot for market ${market}. Please try again.`);
                }

                // Remove key div
                keyDiv.remove();

                // Restore UI elements
                dropdownContainer.style.display = originalStyles.dropdownContainer;
                propertySelector.style.display = originalStyles.propertySelector;
                propertySearchContainer.style.display = originalStyles.propertySearchContainer;
                dateTime.style.display = originalStyles.dateTime;
            }

            map.setView(currentCenter, currentZoom);
            originalLayer.addTo(map);
            Object.keys(markers).forEach(index => {
                const prop = properties[index];
                const selectedMarket = document.getElementById('market-selector').value;
                if (selectedMarket === 'all' || prop.market === selectedMarket) {
                    if (!map.hasLayer(markers[index])) {
                        markers[index].addTo(map);
                    }
                }
            });

            document.getElementById('loading-indicator').style.display = 'none';
            document.getElementById('loading-indicator').textContent = 'Loading properties...';

            if (screenshots.length > 0) {
                const { jsPDF } = window.jspdf;
                const dateStr = new Date().toISOString().split('T')[0];
                for (const screenshot of screenshots) {
                    const doc = new jsPDF({ orientation: 'landscape' });
                    const pdfWidth = doc.internal.pageSize.getWidth();
                    const pdfHeight = doc.internal.pageSize.getHeight();

                    const imgProps = doc.getImageProperties(screenshot.dataURL);
                    const scale = Math.min(pdfWidth / imgProps.width, pdfHeight / imgProps.height);
                    const width = imgProps.width * scale;
                    const height = imgProps.height * scale;
                    const x = (pdfWidth - width) / 2;
                    const y = (pdfHeight - height) / 2;
                    doc.addImage(screenshot.dataURL, 'PNG', x, y, width, height);
                    doc.save(`Chattanooga_${screenshot.market}_${dateStr}.pdf`);
                }
            }
        }
async function fetchSheetData() {
  try {
    const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRwGnCRGqtnVfBVM0W-_OUej4LROgQJ1CtdSOuW2H8Dtfcvg6EOfhi6ihQf_Df0MksBW_k_M38X2PFi/pub?gid=0&single=true&output=csv');
    if (!response.ok) {
      throw new Error('Fetch failed: ' + response.status);
    }
    const data = await response.text();
    console.log(data); // Log to check raw CSV
    // Parse CSV (e.g., split by lines/commas or use a library like PapaParse)
    const rows = data.split('\n').map(row => row.split(','));
    // Display data points, e.g., update DOM elements
    document.getElementById('data-container').innerText = JSON.stringify(rows);
  } catch (error) {
    console.error('Error fetching Sheet:', error);
  }
}
        // Parse CSV and initialize map markers
        Papa.parse('https://docs.google.com/spreadsheets/d/e/2PACX-1vRwGnCRGqtnVfBVM0W-_OUej4LROgQJ1CtdSOuW2H8Dtfcvg6EOfhi6ihQf_Df0MksBW_k_M38X2PFi/pub?gid=0&single=true&output=csv', {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: async function(results) {
                document.getElementById('loading-indicator').style.display = 'block';
                document.getElementById('loading-indicator').textContent = 'Loading properties...';

                properties = results.data
                    .map(row => ({
                        name: row.Name || 'N/A',
                        lat: parseFloat(row.lat),
                        lng: parseFloat(row.lng),
                        zoning: row.Zoning || 'N/A',
                        ac: row.ac || 'N/A',
                        market: row.Market || 'N/A',
                        dollar_per_sf: row['$/sf'] || 'N/A',
                        price: row.Price || 'N/A',
                        link: row.link || 'N/A'
                    }))
                    .filter(row => !isNaN(row.lat) && !isNaN(row.lng));

                if (properties.length > 0) {
                    const bounds = L.latLngBounds(properties.map(prop => [prop.lat, prop.lng]));
                    map.fitBounds(bounds.pad(0.2));
                } else {
                    console.warn('No valid properties loaded from CSV. Using fallback view.');
                }

                for (let index = 0; index < properties.length; index++) {
                    const property = properties[index];
                    const number = index + 1;
                    const bgColor = defaultColor;
                    const customIcon = L.divIcon({
                        className: '',
                        html: `<div class="custom-marker-icon" style="background-color: ${bgColor};">${number}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    });

                    const popupContent = `
                        <b>Name:</b> ${property.name}<br>
                        <b>Lat:</b> ${property.lat}<br>
                        <b>Lng:</b> ${property.lng}<br>
                        <b>Zoning:</b> ${property.zoning}<br>
                        <b>AC:</b> ${property.ac}<br>
                        <b>Market:</b> ${property.market}<br>
                        <b>$/sf:</b> ${property.dollar_per_sf}<br>
                        <b>Price:</b> ${property.price}<br>
                        <a href="${property.link}" target="_blank">View Brochure / Details</a><br>
                        <label><input type="checkbox" class="exclude-checkbox" data-index="${index}"> Exclude from table</label>
                    `;

                    const marker = L.marker([property.lat, property.lng], { icon: customIcon })
                        .addTo(map)
                        .bindPopup(popupContent);

                    markers[index] = marker;
                }

                const selector = document.getElementById('property-selector');
                selector.innerHTML = '<option value="">Select a property...</option>';
                properties.forEach(function(property, index) {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = `${index + 1}: ${property.name}`;
                    selector.appendChild(option);
                });

                selector.addEventListener('change', function() {
                    const selectedIndex = parseInt(this.value);
                    if (selectedIndex >= 0) {
                        const property = properties[selectedIndex];
                        map.flyTo([property.lat, property.lng], 15);
                        markers[selectedIndex].openPopup();
                    }
                });

                const searchInput = document.getElementById('property-search');
                const searchResults = document.getElementById('search-results');
                searchInput.addEventListener('input', function() {
                    const value = this.value.toLowerCase();
                    searchResults.innerHTML = '';
                    if (value === '') {
                        searchResults.style.display = 'none';
                        return;
                    }
                    const matchingProperties = properties.filter((prop, index) => prop.name.toLowerCase().includes(value));
                    if (matchingProperties.length > 0) {
                        matchingProperties.forEach((prop, i) => {
                            const originalIndex = properties.indexOf(prop);
                            const resultItem = document.createElement('div');
                            resultItem.textContent = `${originalIndex + 1}: ${prop.name}`;
                            resultItem.onclick = function() {
                                map.flyTo([prop.lat, prop.lng], 15);
                                markers[originalIndex].openPopup();
                                searchResults.style.display = 'none';
                                searchInput.value = '';
                            };
                            searchResults.appendChild(resultItem);
                        });
                        searchResults.style.display = 'block';
                    } else {
                        searchResults.style.display = 'none';
                    }
                });

                const markets = [...new Set(properties.map(p => p.market).filter(m => m !== 'N/A' && m !== ''))];
                const marketSelector = document.getElementById('market-selector');
                marketSelector.innerHTML = '<option value="all">All Markets</option>';
                markets.forEach(function(market) {
                    const option = document.createElement('option');
                    option.value = market;
                    option.textContent = market;
                    marketSelector.appendChild(option);
                });

                marketSelector.addEventListener('change', function() {
                    const selectedMarket = this.value;
                    Object.keys(markers).forEach(function(index) {
                        const prop = properties[index];
                        if (selectedMarket === 'all' || prop.market === selectedMarket) {
                            if (!map.hasLayer(markers[index])) {
                                markers[index].addTo(map);
                            }
                        } else {
                            if (map.hasLayer(markers[index])) {
                                map.removeLayer(markers[index]);
                            }
                        }
                    });

                    if (selectedMarket === 'all') {
                        const visibleProperties = properties.filter((_, index) => !excluded.has(index));
                        if (visibleProperties.length > 0) {
                            const bounds = L.latLngBounds(visibleProperties.map(prop => [prop.lat, prop.lng]));
                            map.fitBounds(bounds.pad(0.2));
                        }
                    } else {
                        const marketProperties = properties.filter((prop, index) => prop.market === selectedMarket && !excluded.has(index));
                        if (marketProperties.length > 0) {
                            const bounds = L.latLngBounds(marketProperties.map(prop => [prop.lat, prop.lng]));
                            map.fitBounds(bounds.pad(0.2));
                        }
                    }
                });

                document.getElementById('manage-exclusions').addEventListener('click', function() {
                    const modal = document.getElementById('exclusions-modal');
                    modal.style.display = 'block';
                    const list = document.getElementById('exclusions-list');
                    list.innerHTML = '';
                    properties.forEach(function(prop, index) {
                        const li = document.createElement('li');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.dataset.index = index;
                        checkbox.classList.add('exclude-checkbox');
                        if (excluded.has(index)) checkbox.checked = true;
                        li.appendChild(checkbox);
                        li.appendChild(document.createTextNode(` ${index + 1}: ${prop.name}`));
                        list.appendChild(li);
                    });
                });

                document.getElementById('screenshot-markets').addEventListener('click', takeMarketScreenshots);

                const closeSpans = document.getElementsByClassName('close');
                for (let i = 0; i < closeSpans.length; i++) {
                    closeSpans[i].addEventListener('click', function() {
                        this.parentElement.parentElement.style.display = 'none';
                    });
                }

                document.getElementById('send-excluded').addEventListener('click', function() {
                    if (excluded.size === 0) {
                        alert('No properties excluded.');
                        return;
                    }
                    let body = 'Excluded Properties:\n\n';
                    properties.forEach(function(prop, index) {
                        if (excluded.has(index)) {
                            body += `${index + 1}: ${prop.name}\n`;
                            body += `Lat: ${prop.lat}\n`;
                            body += `Lng: ${prop.lng}\n`;
                            body += `Zoning: ${prop.zoning}\n`;
                            body += `AC: ${prop.ac}\n`;
                            body += `Market: ${prop.market}\n`;
                            body += `$/sf: ${prop.dollar_per_sf}\n`;
                            body += `Price: ${prop.price}\n`;
                            body += `Link: ${prop.link}\n\n`;
                        }
                    });
                    const encodedTo = encodeURIComponent('jpistone@national-ios.com');
                    const encodedSubject = encodeURIComponent('Excluded Properties');
                    const encodedBody = encodeURIComponent(body);
                    const outlookUrl = `https://outlook.office.com/mail/deeplink/compose?to=${encodedTo}&subject=${encodedSubject}&body=${encodedBody}`;
                    window.open(outlookUrl, '_blank');
                });

                document.getElementById('loading-indicator').style.display = 'none';
            },
            error: function(error) {
                console.error('Error loading CSV:', error);
                document.getElementById('property-selector').innerHTML = '<option value="">Error loading properties</option>';
                document.getElementById('property-search').placeholder = 'Error loading properties';
                document.getElementById('market-selector').innerHTML = '<option value="">Error loading markets</option>';
                document.getElementById('loading-indicator').style.display = 'none';
            }
        });

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('exclude-checkbox')) {
                const index = parseInt(e.target.dataset.index);
                if (e.target.checked) {
                    excluded.add(index);
                } else {
                    excluded.delete(index);
                }
            }
        });
    </script>
</body>
</html>
